<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thirty.user.mapper.LogOperationMapper">

    <select id="getLogOperations" resultType="com.thirty.user.model.vo.LogOperationVO">
        SELECT
            lo.id,
            d.name,
            lo.module,
            lo.description,
            lo.type,
            lo.method,
            lo.code,
            lo.url,
            lo.ip,
            lo.operate_time,
            lo.create_time
        FROM log_operation lo
        LEFT JOIN `detail` d on lo.user_id = d.id
        <where>
            <!-- 角色权限过滤：只显示用户的所有角色都在permittedRoleIds列表中的操作日志 -->
            <if test="permittedRoleIds != null and permittedRoleIds.size() > 0">
                AND lo.user_id IN (
                    SELECT ur.user_id 
                    FROM user_role ur 
                    WHERE ur.is_delete = 0
                    GROUP BY ur.user_id
                    HAVING COUNT(DISTINCT ur.role_id) = SUM(
                        CASE WHEN ur.role_id IN 
                        <foreach collection="permittedRoleIds" item="roleId" open="(" close=")" separator=",">
                            #{roleId}
                        </foreach>
                        THEN 1 ELSE 0 END
                    )
                    AND COUNT(DISTINCT ur.role_id) > 0
                )
            </if>
            <if test="(params.name != null and params.name != '') or (params.description != null and params.description != '')">
                AND (
                <trim suffixOverrides="OR">
                    <if test="params.name != null and params.name != ''">
                        d.name LIKE CONCAT('%', #{params.name}, '%') OR
                    </if>
                    <if test="params.description != null and params.description != ''">
                        lo.description LIKE CONCAT('%', #{params.description}, '%') OR
                    </if>
                </trim>
                )
            </if>
            <if test="params.code != null">
                AND lo.code LIKE CONCAT('%', #{params.code}, '%')
            </if>
            <if test="params.module != null">
                AND lo.module LIKE CONCAT('%', #{params.module}, '%')
            </if>
            <if test="params.type != null">
                AND lo.type = #{params.type}
            </if>
            <if test="params.method != null">
                AND lo.method LIKE CONCAT('%', #{params.method}, '%')
            </if>
            <!-- 时间范围过滤 -->
            <include refid="com.thirty.common.mapper.TimeMapper.timeFilterWrapper">
                <property name="createTimeColumn" value="lo.create_time"/>
                <property name="operateTimeColumn" value="lo.operate_time"/>
            </include>
        </where>
        <!-- 排序 -->
        <include refid="com.thirty.common.mapper.TimeMapper.orderBy">
            <property name="createTimeColumn" value="lo.create_time"/>
            <property name="operateTimeColumn" value="lo.operate_time"/>
            <property name="defaultColumn" value="lo.id"/>
            <property name="defaultDirection" value="DESC"/>
        </include>
    </select>
</mapper>