# 项目架构说明

## 1. 模块结构

Auth Matrix 后端采用 Maven 多模块架构，各模块职责清晰，依赖关系明确。

### 1.1 模块组成

```
backend/
├── am-common          # 通用模块（最底层）
├── am-system          # 系统模块
├── am-user            # 用户权限模块
└── am-core            # 核心启动模块（最上层）
```

### 1.2 模块依赖关系

```
am-core (启动模块)
├── am-user (用户权限模块)
│   ├── am-common (通用模块)
│   └── am-system (系统模块)
├── am-system (系统模块)
│   └── am-common (通用模块)
└── am-common (通用模块)
```

**依赖说明：**

- **am-common**: 最底层模块，提供通用工具、配置、注解、异常处理等基础功能
- **am-system**: 依赖 common，提供系统配置、文件上传、日志等系统级功能
- **am-user**: 依赖 common 和 system，提供用户管理、角色管理、权限管理等核心业务
- **am-core**: 依赖所有模块，负责应用启动、统一配置、组件扫描

### 1.3 各模块详细说明

#### am-common（通用模块）

**职责：** 提供所有模块共享的基础功能

**主要内容：**
- 统一返回结果封装（ResultDTO）
- 全局异常处理
- 通用注解（操作日志、限流等）
- 工具类（JWT、Redis、加密等）
- 枚举定义（操作类型、结果码等）
- MyBatis Plus 配置
- Spring Security 配置
- Redis 配置
- 多数据源配置

**关键配置：**
- `MybatisPlusConfig`: 分页插件、逻辑删除配置
- `SecurityProperties`: Security 白名单配置
- `RedisConfig`: Redis 序列化配置
- `OpenApiConfig`: API 文档配置

#### am-system（系统模块）

**职责：** 提供系统级功能支持

**主要功能：**
- 文件上传（阿里云 OSS）
- 系统配置管理
- 系统级日志（与业务日志分离）

**数据库：** `am_system`

**关键类：**
- `FileController`: 文件上传接口
- `SettingController`: 系统配置接口
- `OssConfig`: OSS 配置类
- `SettingApi`: 对外提供的配置查询接口

#### am-user（用户权限模块）

**职责：** 实现 RBAC1.0 权限管理体系

**主要功能：**
- 用户管理（增删改查、封禁解封）
- 角色管理（角色层次、权限分配）
- 菜单权限管理（前端菜单、后端权限）
- 登录认证（JWT）
- 操作日志、登录日志
- 公告管理
- 用户偏好设置

**数据库：** `am_user`

**关键类：**
- `SecurityConfig`: Spring Security 配置
- `JwtAuthenticationFilter`: JWT 认证过滤器
- `AuthController`: 登录认证接口
- `UserController`: 用户管理接口
- `RoleController`: 角色管理接口
- `PermissionBkController`: 权限管理接口

#### am-core（核心启动模块）

**职责：** 应用启动入口和统一配置

**主要内容：**
- `Application.java`: Spring Boot 启动类
- `application.yml`: 统一配置文件
- `application-dev.yml`: 开发环境配置
- 组件扫描配置
- Mapper 扫描配置

**关键配置：**
```java
@SpringBootApplication(scanBasePackages = {"com.thirty"})
@MapperScan("com.thirty.**.mapper")
@EnableTransactionManagement
@EnableAspectJAutoProxy(exposeProxy = true)
```

## 2. 数据库架构

### 2.1 双数据库设计

项目采用**物理分离**的双数据库设计：

| 数据库 | 用途 | 包含模块 |
|--------|------|----------|
| `am_user` | 用户权限数据 | 用户、角色、权限、日志 |
| `am_system` | 系统配置数据 | 系统配置、文件记录 |

**设计优势：**
- 业务隔离：用户权限与系统配置独立
- 性能优化：可针对不同数据库优化
- 扩展性强：便于后续拆分微服务
- 安全性高：权限数据独立管理

### 2.2 数据源切换机制

项目使用 `dynamic-datasource` + **AOP 切面**实现数据源切换。

**切换规则：** 根据 Service 包路径自动切换数据源

| Service 包路径 | 数据源 | 数据库 |
|--------------|--------|--------|
| `com.thirty.user.service` | user | am_user |
| `com.thirty.system.service` | system | am_system |

**切面配置位置：** `am-core/src/main/java/com/thirty/core/aspect/AutoDataSourceAspect.java`

```java
@Aspect
@Component
@Order(0)
public class AutoDataSourceAspect {
    @Before("execution(* com.thirty.system.service..*(..))")
    public void setCommonDataSource() {
        DynamicDataSourceContextHolder.push("system");
    }

    @Before("execution(* com.thirty.user.service..*(..))")
    public void setUserDataSource() {
        DynamicDataSourceContextHolder.push("user");
    }

    @After("execution(* com.thirty.system.service..*(..))")
    public void clearCommonDataSource() {
        DynamicDataSourceContextHolder.poll();
    }

    @After("execution(* com.thirty.user.service..*(..))")
    public void clearUserDataSource() {
        DynamicDataSourceContextHolder.poll();
    }
}
```

**重要：** 创建新模块后，需要在切面中添加对应的数据源切换方法！

## 3. 代码分层架构

### 3.1 标准分层

```
Controller (控制层)
    ↓ 接收请求、参数校验、返回结果
Facade (门面层)
    ↓ 业务编排、事务控制
Domain Service (领域服务层)
    ↓ 业务逻辑实现
Basic Service (基础服务层)
    ↓ 数据操作封装
Mapper (持久层)
    ↓ 数据库访问
Database
```

### 3.2 各层职责

#### Controller（控制层）

**职责：**
- 接收 HTTP 请求
- 参数校验（@Valid）
- 权限控制（@PreAuthorize）
- 调用 Facade 层
- 返回统一结果（ResultDTO）

**示例：**
```java
@RestController
@RequestMapping("/user")
@OperateModule("用户管理")
public class UserController {
    @Resource
    private UserFacade userFacade;
    
    @PostMapping("/add")
    @PreAuthorize("hasAuthority('user:add')")
    @OperateLog(type = OperationType.INSERT, description = "添加用户")
    public ResultDTO<Void> addUser(@RequestBody @Valid AddUserDTO dto) {
        userFacade.addUser(dto);
        return ResultDTO.of(UserResultCode.USER_ADD_SUCCESS);
    }
}
```

#### Facade（门面层）

**职责：**
- 异常处理和业务校验
- 数据级别的权限校验
- 协调多个小模块之间的操作
- 业务流程编排

**示例：**
```java
@Service
public class UserFacadeImpl implements UserFacade {
    @Resource
    private UserDomain userDomain;
    @Resource
    private RoleDomain roleDomain;
    
    @Override
    public void addUser(Integer operatorId, AddUserDTO dto) {
        // 1. 权限校验
        if (!hasPermission(operatorId, "user:add")) {
            throw new BusinessException(GlobalResultCode.PERMISSION_DENIED);
        }
        
        // 2. 业务校验
        if (userDomain.existsByUsername(dto.getUsername())) {
            throw new BusinessException(UserResultCode.USERNAME_EXISTS);
        }
        
        // 3. 调用 Domain 层
        Integer userId = userDomain.createUser(dto);
        
        // 4. 协调其他模块
        if (dto.getRoleIds() != null) {
            roleDomain.assignRoles(userId, dto.getRoleIds());
        }
    }
}
```

#### Domain（领域服务层）

**职责：**
- 对象转换（DTO/Entity/VO）
- 事务管理（@Transactional）
- 协调多表之间的操作
- 实现具体业务逻辑

**示例：**
```java
@Service
public class UserDomainImpl implements UserDomain {
    @Resource
    private UserBasicService userBasicService;
    @Resource
    private UserDetailBasicService userDetailBasicService;
    @Resource
    private UserConverter userConverter;
    
    @Override
    @Transactional(rollbackFor = Exception.class)
    public Integer createUser(AddUserDTO dto) {
        // 1. 对象转换
        User user = userConverter.toEntity(dto);
        
        // 2. 保存用户主表
        userBasicService.save(user);
        
        // 3. 保存用户详情表
        UserDetail detail = new UserDetail();
        detail.setUserId(user.getId());
        userDetailBasicService.save(detail);
        
        return user.getId();
    }
}
```

#### Basic Service（基础服务层）

**职责：**
- 继承 MyBatis Plus 的 IService
- 对单一表进行增删改查
- 提供基础 CRUD 操作

**示例：**
```java
@Service
public class UserBasicServiceImpl 
    extends ServiceImpl<UserMapper, User> 
    implements UserBasicService {
    // 继承了 save、update、delete、getById 等方法
}
```

#### Mapper（持久层）

**职责：**
- 继承 MyBatis Plus 的 BaseMapper
- 定义自定义 SQL 方法
- 对应 XML 映射文件

**示例：**
```java
public interface UserMapper extends BaseMapper<User> {
    IPage<UserVO> getUsers(IPage<UserVO> page, @Param("params") GetUsersDTO params);
}
```

### 3.3 包结构规范

```
com.thirty.{module}/
├── controller/          # 控制器
├── service/
│   ├── facade/         # 门面服务
│   │   └── impl/
│   ├── domain/         # 领域服务
│   │   └── impl/
│   └── basic/          # 基础服务
│       └── impl/
├── mapper/             # 数据访问
├── model/
│   ├── entity/         # 实体类
│   ├── dto/            # 数据传输对象
│   └── vo/             # 视图对象
├── converter/          # 对象转换（MapStruct）
├── enums/
│   ├── model/          # 业务枚举
│   └── result/         # 结果码枚举
├── config/             # 配置类
├── annotation/         # 自定义注解
├── aspect/             # 切面
├── filter/             # 过滤器
├── exception/          # 异常处理
├── constant/           # 常量定义
├── utils/              # 工具类
└── validator/          # 自定义校验器
```

## 4. 启动流程

### 4.1 应用启动

1. **加载配置文件**
   - `application.yml`: 基础配置
   - `application-dev.yml`: 环境配置（覆盖基础配置）

2. **组件扫描**
   - 扫描 `com.thirty` 包下所有组件
   - 扫描 `com.thirty.**.mapper` 下所有 Mapper

3. **初始化数据源**
   - 创建 user 数据源连接池
   - 创建 system 数据源连接池
   - 配置数据源路由规则

4. **初始化 Security**
   - 加载 JWT 配置
   - 配置认证过滤器
   - 配置权限拦截规则

5. **启动 Web 服务**
   - 默认端口：8080
   - API 文档：http://localhost:8080/doc.html

### 4.2 请求处理流程

```
HTTP 请求
    ↓
JwtAuthenticationFilter (JWT 验证)
    ↓
Spring Security (权限验证)
    ↓
Controller (接收请求)
    ↓
Facade (业务编排)
    ↓
Domain/Basic Service (业务逻辑)
    ↓
Mapper (数据访问)
    ↓
Dynamic Datasource (数据源切换)
    ↓
Database (数据库)
    ↓
返回结果 (ResultDTO)
```

## 5. 配置文件说明

### 5.1 application.yml（基础配置）

包含所有配置项的模板，敏感信息使用占位符：

```yaml
spring:
  datasource:
    dynamic:
      datasource:
        user:
          username: your_db_username  # 占位符
          password: your_db_password  # 占位符
```

### 5.2 application-dev.yml（开发环境）

覆盖基础配置中的敏感信息，**不提交到 Git**：

```yaml
spring:
  datasource:
    dynamic:
      datasource:
        user:
          username: root
          password: 123456  # 实际密码
```

### 5.3 配置优先级

```
application-dev.yml (最高)
    ↓ 覆盖
application.yml
    ↓ 覆盖
默认配置
```

## 6. 总结

Auth Matrix 后端采用清晰的模块化架构：

- **模块分离**：common、system、user、core 各司其职
- **数据库分离**：user 和 system 物理隔离
- **自动路由**：根据包路径自动切换数据源
- **分层清晰**：Controller → Facade → Domain → Basic → Mapper
- **扩展性强**：便于添加新模块、新功能

下一步，我们将学习如何在此基础上开发新功能模块。
