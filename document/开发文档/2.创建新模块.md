# 创建新模块

本文档将详细说明如何在 Auth Matrix 基础上创建一个新的业务模块。

我们以创建一个**商品管理模块（am-product）**为例，演示完整的开发流程。

## 1. 创建模块目录结构

### 1.1 创建模块文件夹

在 `backend/` 目录下创建新模块：

```
backend/
├── am-product/                    # 新模块根目录
│   ├── src/
│   │   └── main/
│   │       ├── java/
│   │       │   └── com/thirty/product/
│   │       │       ├── controller/           # 控制器
│   │       │       ├── service/
│   │       │       │   ├── facade/          # 门面服务
│   │       │       │   │   └── impl/
│   │       │       │   ├── domain/          # 领域服务
│   │       │       │   │   └── impl/
│   │       │       │   └── basic/           # 基础服务
│   │       │       │       └── impl/
│   │       │       ├── mapper/              # 数据访问
│   │       │       ├── model/
│   │       │       │   ├── entity/          # 实体类
│   │       │       │   ├── dto/             # 数据传输对象
│   │       │       │   └── vo/              # 视图对象
│   │       │       ├── converter/           # 对象转换
│   │       │       ├── enums/
│   │       │       │   ├── model/           # 业务枚举
│   │       │       │   └── result/          # 结果码枚举
│   │       │       ├── config/              # 配置类
│   │       │       ├── exception/           # 异常处理
│   │       │       └── constant/            # 常量定义
│   │       └── resources/
│   │           └── mapper/                  # MyBatis XML
│   └── pom.xml                              # Maven 配置
```

### 1.2 包命名规范

- 基础包名：`com.thirty.{模块名}`
- 示例：`com.thirty.product`
- 保持与现有模块一致的命名风格

## 2. 配置 Maven

### 2.1 创建模块 pom.xml

在 `backend/am-product/pom.xml` 创建配置文件：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
         https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <!-- 继承父项目 -->
    <parent>
        <groupId>com.thirty</groupId>
        <artifactId>backend</artifactId>
        <version>0.0.1-SNAPSHOT</version>
        <relativePath>../pom.xml</relativePath>
    </parent>

    <!-- 模块信息 -->
    <artifactId>am-product</artifactId>
    <name>am-product</name>
    <description>商品管理模块</description>

    <dependencies>
        <!-- 必须依赖：common 模块 -->
        <dependency>
            <groupId>com.thirty</groupId>
            <artifactId>am-common</artifactId>
        </dependency>

        <!-- 可选依赖：如果需要使用 system 模块的功能（如文件上传） -->
        <dependency>
            <groupId>com.thirty</groupId>
            <artifactId>am-system</artifactId>
        </dependency>

        <!-- 可选依赖：如果需要使用 user 模块的功能（如获取用户信息） -->
        <dependency>
            <groupId>com.thirty</groupId>
            <artifactId>am-user</artifactId>
        </dependency>

        <!-- Lombok -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>

        <!-- MapStruct -->
        <dependency>
            <groupId>org.mapstruct</groupId>
            <artifactId>mapstruct</artifactId>
        </dependency>
        <dependency>
            <groupId>org.mapstruct</groupId>
            <artifactId>mapstruct-processor</artifactId>
        </dependency>
    </dependencies>
</project>
```

**依赖说明：**
- `am-common`：必须依赖，提供基础功能
- `am-system`：可选，如果需要文件上传等系统功能
- `am-user`：可选，如果需要获取用户信息、权限验证等

### 2.2 在父 pom.xml 中注册模块

编辑 `backend/pom.xml`：

```xml
<modules>
    <module>am-common</module>
    <module>am-system</module>
    <module>am-user</module>
    <module>am-product</module>  <!-- 新增 -->
    <module>am-core</module>
</modules>
```

在 `<dependencyManagement>` 中添加：

```xml
<dependencyManagement>
    <dependencies>
        <!-- 新增模块依赖管理 -->
        <dependency>
            <groupId>com.thirty</groupId>
            <artifactId>am-product</artifactId>
            <version>${project.version}</version>
        </dependency>
        <!-- 其他依赖... -->
    </dependencies>
</dependencyManagement>
```

### 2.3 在 am-core 中引入新模块

编辑 `backend/am-core/pom.xml`：

```xml
<dependencies>
    <!-- 新增：引入 product 模块 -->
    <dependency>
        <groupId>com.thirty</groupId>
        <artifactId>am-product</artifactId>
    </dependency>
    
    <!-- 其他模块依赖... -->
    <dependency>
        <groupId>com.thirty</groupId>
        <artifactId>am-user</artifactId>
    </dependency>
    <dependency>
        <groupId>com.thirty</groupId>
        <artifactId>am-system</artifactId>
    </dependency>
    <dependency>
        <groupId>com.thirty</groupId>
        <artifactId>am-common</artifactId>
    </dependency>
</dependencies>
```

## 3. 创建数据库

### 3.1 修改数据库初始化脚本

编辑 `backend/sql/init.sql`，添加新数据库：

```sql
CREATE DATABASE IF NOT EXISTS am_user CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE DATABASE IF NOT EXISTS am_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE DATABASE IF NOT EXISTS am_product CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;  -- 新增
```

### 3.2 创建表结构脚本

创建 `backend/sql/schema/am_product.sql`：

```sql
USE am_product;

-- 商品表
CREATE TABLE IF NOT EXISTS product (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '商品ID',
    name VARCHAR(100) NOT NULL COMMENT '商品名称',
    description TEXT COMMENT '商品描述',
    price DECIMAL(10,2) NOT NULL COMMENT '商品价格',
    stock INT NOT NULL DEFAULT 0 COMMENT '库存数量',
    category_id INT COMMENT '分类ID',
    image_url VARCHAR(500) COMMENT '商品图片URL',
    status TINYINT NOT NULL DEFAULT 1 COMMENT '状态：0-下架 1-上架',
    is_deleted TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除：0-未删除 1-已删除',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_category (category_id),
    INDEX idx_status (status),
    INDEX idx_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='商品表';

-- 商品分类表
CREATE TABLE IF NOT EXISTS product_category (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '分类ID',
    name VARCHAR(50) NOT NULL COMMENT '分类名称',
    parent_id INT DEFAULT NULL COMMENT '父分类ID',
    sort INT NOT NULL DEFAULT 0 COMMENT '排序',
    is_deleted TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除：0-未删除 1-已删除',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_parent (parent_id),
    INDEX idx_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='商品分类表';
```

**表设计规范：**
- 主键统一使用 `id`，自增
- 必须包含 `is_deleted` 字段（逻辑删除）
- 必须包含 `create_time` 和 `update_time`
- 字符集统一使用 `utf8mb4`
- 添加必要的索引

### 3.3 创建初始数据脚本

创建 `backend/sql/data/am_product.sql`：

```sql
USE am_product;

-- 插入商品分类
INSERT INTO product_category (id, name, parent_id, sort) VALUES
(1, '电子产品', NULL, 1),
(2, '服装鞋包', NULL, 2),
(3, '手机', 1, 1),
(4, '电脑', 1, 2),
(5, '男装', 2, 1),
(6, '女装', 2, 2);

-- 插入测试商品
INSERT INTO product (name, description, price, stock, category_id, status) VALUES
('iPhone 15 Pro', '苹果最新旗舰手机', 7999.00, 100, 3, 1),
('MacBook Pro', '专业笔记本电脑', 12999.00, 50, 4, 1),
('休闲T恤', '纯棉舒适T恤', 99.00, 200, 5, 1);
```

### 3.4 更新部署脚本

编辑 `backend/sql/setup.bat`，在适当位置添加 product 数据库的部署步骤：

在 "Step 3/4" 之后添加：

```batch
echo Step 4/6: 正在创建商品模块表结构...
if "%USE_DOCKER%"=="true" (
    type schema\am_product.sql | docker exec -i !DOCKER_CONTAINER! mysql -h!MYSQL_HOST! -P!MYSQL_PORT! -u root -p!MYSQL_PASSWORD! 2>nul
) else (
    mysql -u root -p!MYSQL_PASSWORD! < schema\am_product.sql 2>nul
)
if !errorlevel! neq 0 (
    echo ERROR: 商品模块表结构创建失败
    goto end
)
echo OK: 完成
```

在数据导入部分也添加相应的 product 数据导入逻辑。

## 4. 配置数据源

### 4.1 添加数据源配置

编辑 `backend/am-core/src/main/resources/application.yml`：

```yaml
spring:
  datasource:
    dynamic:
      primary: user
      strict: false
      datasource:
        user:
          url: jdbc:mysql://localhost:3306/am_user?allowPublicKeyRetrieval=true&useSSL=false
          username: your_db_username
          password: your_db_password
          driver-class-name: com.mysql.cj.jdbc.Driver
        system:
          url: jdbc:mysql://localhost:3306/am_system?allowPublicKeyRetrieval=true&useSSL=false
          username: your_db_username
          password: your_db_password
          driver-class-name: com.mysql.cj.jdbc.Driver
        product:  # 新增数据源
          url: jdbc:mysql://localhost:3306/am_product?allowPublicKeyRetrieval=true&useSSL=false
          username: your_db_username
          password: your_db_password
          driver-class-name: com.mysql.cj.jdbc.Driver
```

### 4.2 开发环境配置

编辑 `backend/am-core/src/main/resources/application-dev.yml`：

```yaml
spring:
  datasource:
    dynamic:
      datasource:
        user:
          username: root
          password: 123456
        system:
          username: root
          password: 123456
        product:  # 新增
          username: root
          password: 123456
```

### 4.3 添加数据源切换切面

**重要步骤：** 编辑 `backend/am-core/src/main/java/com/thirty/core/aspect/AutoDataSourceAspect.java`

添加 product 模块的数据源切换：

```java
@Aspect
@Component
@Order(0)
public class AutoDataSourceAspect {
    // 现有的 system 和 user 数据源切换...
    
    // 新增：product 数据源切换
    @Before("execution(* com.thirty.product.service..*(..))")
    public void setProductDataSource() {
        DynamicDataSourceContextHolder.push("product");
    }

    @After("execution(* com.thirty.product.service..*(..))")
    public void clearProductDataSource() {
        DynamicDataSourceContextHolder.poll();
    }
}
```

**切换规则：**
- 当调用 `com.thirty.product.service` 包下的任何方法时
- 切面会自动切换到 `product` 数据源
- 方法执行完毕后自动清除数据源上下文

**注意：** 必须在切面中添加，否则新模块无法访问对应的数据库！

## 5. 验证模块创建

### 5.1 编译项目

```bash
# 在 backend 目录下执行
mvnw clean compile
```

如果编译成功，说明模块创建正确。

### 5.2 部署数据库

```bash
# 在 backend/sql 目录下执行
setup.bat
```

按提示输入数据库信息，完成数据库部署。

### 5.3 检查数据库

连接 MySQL，检查是否创建成功：

```sql
-- 查看数据库
SHOW DATABASES;

-- 查看表
USE am_product;
SHOW TABLES;

-- 查看数据
SELECT * FROM product;
SELECT * FROM product_category;
```

## 6. 模块创建检查清单

创建新模块后，请检查以下项目：

- [ ] 创建了模块目录结构
- [ ] 创建了 `pom.xml` 并配置了依赖
- [ ] 在父 `pom.xml` 中注册了模块
- [ ] 在 `am-core` 中引入了模块
- [ ] 创建了数据库初始化脚本（`init.sql`）
- [ ] 创建了表结构脚本（`schema/am_product.sql`）
- [ ] 创建了初始数据脚本（`data/am_product.sql`）
- [ ] 更新了部署脚本（`setup.bat`）
- [ ] 在 `application.yml` 中配置了数据源
- [ ] 在 `application-dev.yml` 中配置了开发环境
- [ ] **在 `AutoDataSourceAspect.java` 中添加了数据源切换方法**
- [ ] 编译项目成功
- [ ] 部署数据库成功

## 7. 下一步

模块创建完成后，接下来可以：

1. 开发业务代码（参考《3.开发业务代码.md》）
2. 配置权限控制（参考《4.权限控制集成.md》）
3. 使用现有模块功能（参考《5.使用现有模块.md》）

---

**提示：** 创建新模块是一个机械的过程，建议将本文档作为检查清单，确保每一步都正确完成。
